---
title: "PH241 Final Project - Model Fits"
output: html_notebook
---

***
### Setup
```{r, warning=FALSE, message=FALSE}
# Importing Libraries
library(dplyr)
library(data.table)
library(DataExplorer)

# Setting File Paths
prefix = "~/PH241/Final Project/Data/Cleaned/"
setwd(prefix)
filepaths = c("washb-bangladesh-merged-public.csv",
              "washb-bangladesh-compoundAdherence-limited-public.csv"
              )

mergedData = fread(filepaths[1], data.table=FALSE) %>% select(-V1)
compoundAdherence.limited = fread(filepaths[2], data.table=FALSE) %>% select(-V1) %>% rename(svyHumFeces = humfeces, svyLatFeces = latfeces)

fit.report = function(fit) {
    # Reporting Log Odds Ratios (Model fit)
    fit %>% summary %>% print
    writeLines("\n\nORs")
    # Reporting Odds Ratios (Coefficients)
    fit %>% coef %>% exp %>% print
    writeLines("\n\nConfidence Intervals of ORs")
    #Reporting Confidence Intervals of Odds Ratios
    fit %>% confint %>% exp %>% print
    writeLines("\n\n")
}
```

Let's begin with an overview of the two datasets we'll be looking at. Our merged dataset includes one binary outcome variable (`allCauseDiarrhea`) some identification variables (`dataid`, `childid`, `clusterid`, `block`, `svy`), some treatment-specific variables (`tr`, ``) a variety of explanatory variables. Each row represents a measurement of a child's diarrheal status over the last 7 days, where 0 indicates no diarrhea and 1 indicates some report of diarrhea, where diarrhea was defined as >= 3 loose or watery stools in 24 hours or >= 1 stool with blood over the 7 days prior to measurement.

```{r}
mergedData %>% head
compoundAdherence.limited %>% head
```

In this analysis, we'll be looking at the specific one arm of the WashB study, which deployed Lipid-based Nutrient Supplements (LNS) sachets to compounds receiving the "Nutrition" and "Nutrition + WSH" intervention. We'll need to restrict our data to that specific intervention arm and merge in survey-level data on LNS sachet adherence to proceed.
```{r}
nutritionArmData = mergedData %>% filter(tr=="Nutrition" | tr=="Nutrition + WSH")
nutritionArmData = nutritionArmData %>% 
    left_join(compoundAdherence.limited %>% 
                  select(dataid, svy, lnsp, rlnsp, svyHumFeces, svyLatFeces),
              by=c("dataid", "svy")) %>%
    select(-wsbinary, -wscategorical)

nutritionArmData %>% head
nutritionArmData %>% nrow
```
Now that we have our data, lets fit our null hypothesis model, examining only the effect of % expected consumption of LNS satchets (`lnsp`), where 14 is the "expected" number of satchets consumed per week and the actual consumption is extrapolated out to this weekly amount. Let's also ensure there are no outliers in our `lnsp` and remove them if there are -- outliers are < 0% or > 100% or NA. 
```{r}
nutritionArmData %>% select(allCauseDiarrhea, lnsp) %>% summary

nutritionArmDataCleaned = nutritionArmData %>% filter(!is.na(lnsp) & (0 <= lnsp & lnsp <= 100))

nutritionArmDataCleaned %>% select(allCauseDiarrhea, lnsp) %>% summary

fit1.null = glm(formula=allCauseDiarrhea~lnsp, family="binomial", data=nutritionArmDataCleaned)

fit.report(fit1.null)
```
Some initial observations include:
- Yikes, adherence is pretty low in this arm of the trial. It just isn't the case that many people are consuming all of the expected sachets, and that's a valuable source of information about interventions like this which require a lot of "remembering"" and effort from the people receiving the resources. 
- The odds of contracting some form of diarrhea are estimated at around .12
- Though not statistically significant, receiving the `lnsp` supplement and actually adhering to it increased the odds of diarrhea by 1.02 times per percentage point increase. We should be wary of this, however, as there may be confounding present, where less food secure and lower income/education compounds have a greater incentive to consume the satchets as a source of nutrition in the absence of any other food. 

Now, let's fit using some of the covariates that exist. By including covariates that are potential confounders, we are using implicit covariate adjustment methods. 

Now, let's directly adjust for confounding with stratification and different model fits in each stratum.



